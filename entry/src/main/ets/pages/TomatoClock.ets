// TomatoClock.ets
import { FontUtils } from '../utils/FontUtils';
import prompt from '@ohos.prompt';

@Component
export struct TomatoClock {
  @StorageLink('globalFontSize') fontSize: number = 16;

  // çŠ¶æ€å˜é‡
  @State timeRemaining: number = 25 * 60;  // é»˜è®¤25åˆ†é’Ÿ
  @State isRunning: boolean = false;
  @State isWorkMode: boolean = true;      // true=å·¥ä½œæ—¶é—´, false=ä¼‘æ¯æ—¶é—´
  @State completedPomodoros: number = 0;  // å®Œæˆçš„ç•ªèŒ„æ•°
  @State timerId: number = 0;

  // é…ç½®
  private readonly workDuration: number = 25 * 60;  // 25åˆ†é’Ÿ
  private readonly breakDuration: number = 5 * 60;  // 5åˆ†é’Ÿ
  private readonly longBreakDuration: number = 15 * 60; // 15åˆ†é’Ÿ
  private readonly pomodorosBeforeLongBreak: number = 4;

  // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
  get progressPercentage(): number {
    const totalTime = this.isWorkMode ? this.workDuration : this.breakDuration;
    return ((totalTime - this.timeRemaining) / totalTime) * 100;
  }

  build() {
    Column({ space: 20 }) {
      //=================== é¡µé¢æ ‡é¢˜ ===================
      Text(this.isWorkMode ? 'ğŸ… å·¥ä½œæ—¶é—´' : 'â˜• ä¼‘æ¯æ—¶é—´')
        .fontSize(FontUtils.getTitleSize(this.fontSize))
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .margin({ top: 30 })

      //=================== å®Œæˆç•ªèŒ„æ•°ç»Ÿè®¡ ===================
      Row() {
        Text('å·²å®Œæˆï¼š')
          .fontSize(FontUtils.getBodySize(this.fontSize))
          .fontColor($r('app.color.text_secondary'))
        Text(`${this.completedPomodoros} ä¸ªç•ªèŒ„`)
          .fontSize(FontUtils.getBodySize(this.fontSize))
          .fontColor($r('app.color.primary_blue'))
          .fontWeight(FontWeight.Medium)
      }
      .margin({ bottom: 10 })

      //=================== æ—¶é’Ÿæ˜¾ç¤ºåŒºåŸŸ ===================
      Column() {
        // è¿›åº¦ç¯
        Stack() {
          // èƒŒæ™¯ç¯
          Circle()
            .width(200)
            .height(200)
            .fill('transparent')
            .stroke($r('app.color.background_tertiary'))
            .strokeWidth(10)

          // è¿›åº¦ç¯
          Circle()
            .width(200)
            .height(200)
            .fill('transparent')
            .stroke(this.isWorkMode ? $r('app.color.primary_red') : $r('app.color.primary_green'))
            .strokeWidth(10)
            .strokeDashArray([this.progressPercentage * 6.28, 6.28]) // 2Ï€r â‰ˆ 6.28

          // æ—¶é—´æ˜¾ç¤º
          Column() {
            Text(Math.floor(this.timeRemaining / 60).toString().padStart(2, '0'))
              .fontSize(48)
              .fontColor($r('app.color.text_primary'))
              .fontWeight(FontWeight.Bold)
            Text(':')
              .fontSize(48)
              .fontColor($r('app.color.text_primary'))
              .margin({ top: -20, bottom: -20 })
            Text((this.timeRemaining % 60).toString().padStart(2, '0'))
              .fontSize(48)
              .fontColor($r('app.color.text_primary'))
              .fontWeight(FontWeight.Bold)
          }
        }

        // æ¨¡å¼è¯´æ˜
        Text(this.isWorkMode ? 'ä¸“æ³¨å·¥ä½œï¼Œé¿å…åˆ†å¿ƒ' : 'æ”¾æ¾ä¼‘æ¯ï¼Œå‡†å¤‡ä¸‹ä¸€è½®')
          .fontSize(FontUtils.getSmallSize(this.fontSize))
          .fontColor($r('app.color.text_tertiary'))
          .margin({ top: 20 })
      }
      .margin({ bottom: 30 })

      //=================== æ§åˆ¶æŒ‰é’®åŒºåŸŸ ===================
      Column({ space: 15 }) {
        // å¼€å§‹/æš‚åœæŒ‰é’®
        Button(this.isRunning ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ å¼€å§‹')
          .width(200)
          .height(50)
          .backgroundColor(this.isRunning ?
            $r('app.color.warning') :
            $r('app.color.primary_green'))
          .fontColor($r('app.color.White'))
          .fontSize(FontUtils.getSmallSize(this.fontSize))
          .borderRadius(25)
          .onClick(() => {
            this.toggleTimer();
          })

        // é‡ç½®æŒ‰é’®
        Button('ğŸ”„ é‡ç½®')
          .width(200)
          .height(50)
          .backgroundColor($r('app.color.button_disabled'))
          .fontColor($r('app.color.text_secondary'))
          .fontSize(FontUtils.getSmallSize(this.fontSize))
          .borderRadius(25)
          .onClick(() => {
            this.resetTimer();
          })

        // åˆ‡æ¢æ¨¡å¼æŒ‰é’®ï¼ˆä»…å½“æœªè¿è¡Œæ—¶æ˜¾ç¤ºï¼‰
        if (!this.isRunning) {
          Button(this.isWorkMode ? 'åˆ‡æ¢åˆ°ä¼‘æ¯' : 'åˆ‡æ¢åˆ°å·¥ä½œ')
            .width(200)
            .height(50)
            .backgroundColor($r('app.color.primary_blue'))
            .fontColor($r('app.color.White'))
            .fontSize(FontUtils.getSmallSize(this.fontSize))
            .borderRadius(25)
            .onClick(() => {
              this.switchMode();
            })
            .margin({ top: 10 })
        }
      }

      //=================== è®¾ç½®åŒºåŸŸ ===================
      Column({ space: 10 }) {
        Text('æ—¶é—´è®¾ç½®')
          .fontSize(FontUtils.getSmallSize(this.fontSize))
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 30, bottom: 10 })

        Row({ space: 20 }) {
          Column() {
            Text('å·¥ä½œæ—¶é—´')
              .fontSize(FontUtils.getSmallSize(this.fontSize))
              .fontColor($r('app.color.text_tertiary'))
            Text('25åˆ†é’Ÿ')
              .fontSize(FontUtils.getBodySize(this.fontSize))
              .fontColor($r('app.color.text_primary'))
          }

          Column() {
            Text('ä¼‘æ¯æ—¶é—´')
              .fontSize(FontUtils.getSmallSize(this.fontSize))
              .fontColor($r('app.color.text_tertiary'))
            Text('5åˆ†é’Ÿ')
              .fontSize(FontUtils.getBodySize(this.fontSize))
              .fontColor($r('app.color.text_primary'))
          }
        }
      }
    }
    .width('100%')
    .height('100%')
    .padding(20)
    .backgroundColor($r('app.color.background_secondary'))
  }

  //=================== è®¡æ—¶å™¨æ§åˆ¶æ–¹æ³• ===================
  // åˆ‡æ¢è®¡æ—¶å™¨çŠ¶æ€
  toggleTimer() {
    if (this.isRunning) {
      this.stopTimer();
    } else {
      this.startTimer();
    }
    this.isRunning = !this.isRunning;
  }

  // å¼€å§‹è®¡æ—¶
  startTimer() {
    this.stopTimer(); // ç¡®ä¿åªæœ‰ä¸€ä¸ªè®¡æ—¶å™¨

    this.timerId = setInterval(() => {
      if (this.timeRemaining > 0) {
        this.timeRemaining -= 1;
      } else {
        this.handleTimerComplete();
      }
    }, 1000) as number;
  }

  // åœæ­¢è®¡æ—¶
  stopTimer() {
    if (this.timerId) {
      clearInterval(this.timerId);
      this.timerId = 0;
    }
  }

  // é‡ç½®è®¡æ—¶å™¨
  resetTimer() {
    this.stopTimer();
    this.isRunning = false;
    this.timeRemaining = this.isWorkMode ? this.workDuration : this.breakDuration;
  }

  // åˆ‡æ¢å·¥ä½œ/ä¼‘æ¯æ¨¡å¼
  switchMode() {
    this.stopTimer();
    this.isRunning = false;
    this.isWorkMode = !this.isWorkMode;
    this.timeRemaining = this.isWorkMode ? this.workDuration : this.breakDuration;
  }

  // å¤„ç†è®¡æ—¶å®Œæˆ
  private handleTimerComplete() {
    this.stopTimer();
    this.isRunning = false;

    if (this.isWorkMode) {
      // å·¥ä½œæ¨¡å¼å®Œæˆ
      this.completedPomodoros += 1;
      prompt.showToast({
        message: 'ğŸ‰ æ­å–œå®Œæˆä¸€ä¸ªç•ªèŒ„é’Ÿï¼å¼€å§‹ä¼‘æ¯å§ï½',
        duration: 3000
      });

      // åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œé•¿ä¼‘æ¯
      const breakTime = (this.completedPomodoros % this.pomodorosBeforeLongBreak === 0)
        ? this.longBreakDuration
        : this.breakDuration;

      // åˆ‡æ¢åˆ°ä¼‘æ¯æ¨¡å¼
      this.isWorkMode = false;
      this.timeRemaining = breakTime;
    } else {
      // ä¼‘æ¯æ¨¡å¼å®Œæˆ
      prompt.showToast({
        message: 'ğŸ’ª ä¼‘æ¯ç»“æŸï¼Œå¼€å§‹æ–°çš„ç•ªèŒ„é’Ÿå§ï¼',
        duration: 3000
      });

      // åˆ‡æ¢å›å·¥ä½œæ¨¡å¼
      this.isWorkMode = true;
      this.timeRemaining = this.workDuration;
    }
  }

  //=================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ===================
  aboutToAppear() {
    // åˆå§‹åŒ–æ—¶é—´
    this.timeRemaining = this.isWorkMode ? this.workDuration : this.breakDuration;
  }

  aboutToDisappear() {
    this.stopTimer();
  }
}