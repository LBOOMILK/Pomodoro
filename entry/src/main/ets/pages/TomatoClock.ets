// TomatoClock.ets
import { FontUtils } from '../utils/FontUtils';
import prompt from '@ohos.prompt';

@Component
export struct TomatoClock {
  @StorageLink('globalFontSize') fontSize: number = 16;

  // çŠ¶æ€å˜é‡
  @State timeRemaining: number = 25 * 60;  // é»˜è®¤25åˆ†é’Ÿ
  @State isRunning: boolean = false;
  @State isWorkMode: boolean = true;      // true=å·¥ä½œæ—¶é—´, false=ä¼‘æ¯æ—¶é—´
  @StorageLink('completedPomodoros') completedPomodoros: number = 0;  // å®Œæˆçš„ç•ªèŒ„æ•°ï¼ŒæŒä¹…åŒ–ä¿å­˜
  @State timerId: number = 0;
  @State speedMultiplier: number = 1;     // æ—¶é—´æµé€Ÿå€æ•°ï¼Œ1=æ­£å¸¸ï¼Œ2=2å€é€Ÿï¼Œ5=5å€é€Ÿ

  // é…ç½®
  @StorageLink('workDuration') workDuration: number = 25 * 60;  // 25åˆ†é’Ÿï¼ŒæŒä¹…åŒ–ä¿å­˜
  @StorageLink('breakDuration') breakDuration: number = 5 * 60;  // 5åˆ†é’Ÿï¼ŒæŒä¹…åŒ–ä¿å­˜
  private readonly longBreakDuration: number = 15 * 60; // 15åˆ†é’Ÿ
  private readonly pomodorosBeforeLongBreak: number = 4;

  // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆéšç€æ—¶é—´å¢åŠ è€Œå¢åŠ ï¼Œè¡¨ç¤ºå·²å®Œæˆçš„æ—¶é—´æ¯”ä¾‹ï¼‰
  get progressPercentage(): number {
    const totalTime = this.isWorkMode ? this.workDuration : this.breakDuration;
    return ((totalTime - this.timeRemaining) / totalTime) * 100;
  }

  build() {
    Scroll() {
      Column({ space: 20 }) {
        //=================== é¡µé¢æ ‡é¢˜ ===================
        Text(this.isWorkMode ? 'ğŸ… å·¥ä½œæ—¶é—´' : 'â˜• ä¼‘æ¯æ—¶é—´')
          .fontSize(FontUtils.getTitleSize(this.fontSize))
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ top: 30 })

        //=================== å®Œæˆç•ªèŒ„æ•°ç»Ÿè®¡ ===================
        Row() {
          Text('å·²å®Œæˆï¼š')
            .fontSize(FontUtils.getBodySize(this.fontSize))
            .fontColor($r('app.color.text_secondary'))
          Text(`${this.completedPomodoros} ä¸ªç•ªèŒ„`)
            .fontSize(FontUtils.getBodySize(this.fontSize))
            .fontColor($r('app.color.primary_blue'))
            .fontWeight(FontWeight.Medium)
        }
        .margin({ bottom: 10 })

        //=================== æ—¶é’Ÿæ˜¾ç¤ºåŒºåŸŸ ===================
        Column() {
          // è¿›åº¦ç¯
          Stack() {
            // èƒŒæ™¯ç¯
            Circle()
              .width(250)
              .height(250)
              .fill('transparent')
              .stroke($r('app.color.background_tertiary'))
              .strokeWidth(15)

            // è¿›åº¦ç¯
            Circle()
              .width(250)
              .height(250)
              .fill('transparent')
              .stroke(this.isWorkMode ? $r('app.color.primary_red') : $r('app.color.primary_green'))
              .strokeWidth(15)
              .strokeDashArray([this.progressPercentage * 6.28, 6.28]) // 2Ï€r â‰ˆ 6.28

            // æ—¶é—´æ˜¾ç¤º
            Row() {
              Text(Math.floor(this.timeRemaining / 60).toString().padStart(2, '0'))
                .fontSize(60)
                .fontColor($r('app.color.text_primary'))
                .fontWeight(FontWeight.Bold)
              Text(':')
                .fontSize(60)
                .fontColor($r('app.color.text_primary'))
                .fontWeight(FontWeight.Bold)
                .margin({ left: 5, right: 5 })
              Text((this.timeRemaining % 60).toString().padStart(2, '0'))
                .fontSize(60)
                .fontColor($r('app.color.text_primary'))
                .fontWeight(FontWeight.Bold)
            }
          }

          // æ¨¡å¼è¯´æ˜
          Text(this.isWorkMode ? 'ä¸“æ³¨å·¥ä½œï¼Œé¿å…åˆ†å¿ƒ' : 'æ”¾æ¾ä¼‘æ¯ï¼Œå‡†å¤‡ä¸‹ä¸€è½®')
            .fontSize(FontUtils.getSmallSize(this.fontSize))
            .fontColor($r('app.color.text_tertiary'))
            .margin({ top: 20 })
        }
        .margin({ bottom: 30 })

        //=================== æ§åˆ¶æŒ‰é’®åŒºåŸŸ ===================
        Column({ space: 15 }) {
          // å¼€å§‹/æš‚åœæŒ‰é’®
          Button(this.isRunning ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ å¼€å§‹')
            .width(200)
            .height(50)
            .backgroundColor(this.isRunning ?
              $r('app.color.warning') :
              $r('app.color.primary_green'))
            .fontColor($r('app.color.White'))
            .fontSize(FontUtils.getSmallSize(this.fontSize))
            .borderRadius(25)
            .onClick(() => {
              this.toggleTimer();
            })

          // é‡ç½®æŒ‰é’®
          Button('ğŸ”„ é‡ç½®')
            .width(200)
            .height(50)
            .backgroundColor($r('app.color.button_disabled'))
            .fontColor($r('app.color.text_secondary'))
            .fontSize(FontUtils.getSmallSize(this.fontSize))
            .borderRadius(25)
            .onClick(() => {
              this.resetTimer();
            })

          // åˆ‡æ¢æ¨¡å¼æŒ‰é’®ï¼ˆä»…å½“æœªè¿è¡Œæ—¶æ˜¾ç¤ºï¼‰
          if (!this.isRunning) {
            Button(this.isWorkMode ? 'åˆ‡æ¢åˆ°ä¼‘æ¯' : 'åˆ‡æ¢åˆ°å·¥ä½œ')
              .width(200)
              .height(50)
              .backgroundColor($r('app.color.primary_blue'))
              .fontColor($r('app.color.White'))
              .fontSize(FontUtils.getSmallSize(this.fontSize))
              .borderRadius(25)
              .onClick(() => {
                this.switchMode();
              })
              .margin({ top: 10 })
          }

          // é€Ÿåº¦æ§åˆ¶æŒ‰é’®
          Row({ space: 10 }) {
            Button('æ­£å¸¸é€Ÿåº¦')
              .width(95)
              .height(40)
              .backgroundColor(this.speedMultiplier === 1 ? $r('app.color.primary_green') : $r('app.color.button_disabled'))
              .fontColor(this.speedMultiplier === 1 ? $r('app.color.White') : $r('app.color.text_secondary'))
              .fontSize(FontUtils.getSmallSize(this.fontSize) - 2)
              .borderRadius(20)
              .onClick(() => {
                this.speedMultiplier = 1;
              })

            Button('30å€é€Ÿ')
              .width(95)
              .height(40)
              .backgroundColor(this.speedMultiplier === 30 ? $r('app.color.primary_green') : $r('app.color.button_disabled'))
              .fontColor(this.speedMultiplier === 30 ? $r('app.color.White') : $r('app.color.text_secondary'))
              .fontSize(FontUtils.getSmallSize(this.fontSize) - 2)
              .borderRadius(20)
              .onClick(() => {
                this.speedMultiplier = 30;
              })

            Button('60å€é€Ÿ')
              .width(95)
              .height(40)
              .backgroundColor(this.speedMultiplier === 60 ? $r('app.color.primary_green') : $r('app.color.button_disabled'))
              .fontColor(this.speedMultiplier === 60 ? $r('app.color.White') : $r('app.color.text_secondary'))
              .fontSize(FontUtils.getSmallSize(this.fontSize) - 2)
              .borderRadius(20)
              .onClick(() => {
                this.speedMultiplier = 60;
              })
          }
          .margin({ top: 20 })
        }
        .margin({ bottom: 30 }) // æ·»åŠ åº•éƒ¨è¾¹è·ï¼Œç¡®ä¿å†…å®¹å®Œå…¨å¯è§
      }
      .width('100%')
      .padding(20)
      .backgroundColor($r('app.color.background_secondary'))
    }
    .width('100%')
    .height('100%')
    .edgeEffect(EdgeEffect.Spring)  // å¼¹æ€§æ»šåŠ¨
  }

  //=================== è®¡æ—¶å™¨æ§åˆ¶æ–¹æ³• ===================
  // åˆ‡æ¢è®¡æ—¶å™¨çŠ¶æ€
  toggleTimer() {
    if (this.isRunning) {
      this.stopTimer();
    } else {
      this.startTimer();
    }
  }

  // å¼€å§‹è®¡æ—¶
  startTimer() {
    // å½»åº•æ¸…ç†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è®¡æ—¶å™¨
    this.stopTimer();
    
    this.isRunning = true;
    
    // é‡æ–°è®¾è®¡è®¡æ—¶å™¨é€»è¾‘ï¼Œä½¿ç”¨æ›´å¯é çš„å®ç°
    const runTimer = () => {
      if (!this.isRunning) {
        return;
      }
      
      // æ ¹æ®é€Ÿåº¦å€æ•°æ›´æ–°æ—¶é—´
      this.timeRemaining = Math.max(0, this.timeRemaining - this.speedMultiplier);
      
      if (this.timeRemaining <= 0) {
        this.handleTimerComplete();
        return;
      }
      
      // ä½¿ç”¨setTimeoutæ›¿ä»£setIntervalï¼Œé¿å…ç´¯ç§¯è¯¯å·®å’Œå¤šå®ä¾‹é—®é¢˜
      this.timerId = setTimeout(runTimer, 1000) as number;
    };
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    runTimer();
  }

  // åœæ­¢è®¡æ—¶
  stopTimer() {
    // æ¸…é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è®¡æ—¶å™¨
    if (this.timerId) {
      clearTimeout(this.timerId);
      clearTimeout(this.timerId); // åŒé‡ä¿é™©
    }
    this.timerId = 0;
    this.isRunning = false;
  }

  // é‡ç½®è®¡æ—¶å™¨
  resetTimer() {
    this.stopTimer();
    this.timeRemaining = this.isWorkMode ? this.workDuration : this.breakDuration;
  }

  // åˆ‡æ¢å·¥ä½œ/ä¼‘æ¯æ¨¡å¼
  switchMode() {
    this.stopTimer();
    this.isWorkMode = !this.isWorkMode;
    this.timeRemaining = this.isWorkMode ? this.workDuration : this.breakDuration;
  }

  // å¤„ç†è®¡æ—¶å®Œæˆ
  private handleTimerComplete() {
    this.stopTimer();

    if (this.isWorkMode) {
      // å·¥ä½œæ¨¡å¼å®Œæˆ
      this.completedPomodoros += 1;
      prompt.showToast({
        message: 'ğŸ‰ æ­å–œå®Œæˆä¸€ä¸ªç•ªèŒ„é’Ÿï¼å¼€å§‹ä¼‘æ¯å§ï½',
        duration: 3000
      });

      // åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œé•¿ä¼‘æ¯
      const breakTime = (this.completedPomodoros % this.pomodorosBeforeLongBreak === 0)
        ? this.longBreakDuration
        : this.breakDuration;

      // åˆ‡æ¢åˆ°ä¼‘æ¯æ¨¡å¼
      this.isWorkMode = false;
      this.timeRemaining = breakTime;
    } else {
      // ä¼‘æ¯æ¨¡å¼å®Œæˆ
      prompt.showToast({
        message: 'ğŸ’ª ä¼‘æ¯ç»“æŸï¼Œå¼€å§‹æ–°çš„ç•ªèŒ„é’Ÿå§ï¼',
        duration: 3000
      });

      // åˆ‡æ¢å›å·¥ä½œæ¨¡å¼
      this.isWorkMode = true;
      this.timeRemaining = this.workDuration;
    }
  }

  //=================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ===================
  aboutToAppear() {
    // åˆå§‹åŒ–æ—¶é—´
    this.timeRemaining = this.isWorkMode ? this.workDuration : this.breakDuration;
  }

  aboutToDisappear() {
    this.stopTimer();
  }
}